<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Menu Admin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@600;700;800&display=swap"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="style/admin.css" />
  </head>

  <body>
    <div class="container">
      <div class="topbar">
        <button id="logoutBtn" class="logout-btn">Logout</button>

        <div
          style="
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
          "
        >
          <img
            id="brandLogo"
            src=""
            alt="Brand logo"
            style="
              border-radius: 1000px;
              width: 80px;
              height: 80px;
              object-fit: cover;
            "
          />
          <h1 id="brandTitle">Admin</h1>
          <p id="brandSlogan">Manage your restaurant menu</p>
        </div>
      </div>

      <div id="status"></div>

      <!-- LOGIN -->
      <div id="loginBox" class="card">
        <h2>Login</h2>
        <div class="row">
          <input id="email" placeholder="Email" />
          <input id="password" type="password" placeholder="Password" />
          <button id="loginBtn">Sign in</button>
        </div>
      </div>

      <!-- ADMIN -->
      <div id="adminBox" style="display: none">
        <div class="card">
          <div class="card">
            <h2>Branding</h2>

            <div class="row row-2">
              <input id="brandInput" placeholder="Brand name" />
              <input id="sloganInput" placeholder="Slogan" />
            </div>

            <div style="height: 12px"></div>

            <div class="row">
              <input id="logoInput" type="file" accept="image/*" />
              <img
  id="logoPreview"
  style="
    display:none;
    margin-top:10px;
    width:80px;
    height:80px;
    border-radius:1000px;
    object-fit:cover;
  "
/>

              <button id="saveBrandingBtn">Save Branding</button>
            </div>
          </div>

          <h2>Add Menu Item</h2>
          <div class="row row-2">
            <input id="name" placeholder="Item name" />
            <input id="price" type="number" placeholder="Price (â‚±)" />
          </div>
          <div style="width: 100%; height: 14px"></div>
          <div class="row">
            <textarea
              id="description"
              placeholder="Item description"
            ></textarea>
            <input id="image" type="file" />
            <button id="addBtn">Add Item</button>
          </div>
        </div>

        <div class="card">
          <h2>Menu Items</h2>

          <div id="items" class="items-grid"></div>
        </div>
      </div>
    </div>

    <div id="confirmModal" class="confirm-backdrop">
      <div class="confirm-card">
        <h3>Delete item?</h3>
        <p>This action cannot be undone.</p>
        <div class="confirm-actions">
          <button id="cancelDelete" class="secondary">Cancel</button>
          <button id="confirmDelete" class="danger">Delete</button>
        </div>
      </div>
    </div>

    <div id="logoutModal" class="confirm-backdrop">
      <div class="confirm-card">
        <h3>Log out?</h3>
        <p>Youâ€™ll need to sign in again to manage the menu.</p>

        <div class="confirm-actions">
          <button id="cancelLogout" class="secondary">Cancel</button>
          <button id="confirmLogout" class="danger">Log out</button>
        </div>
      </div>
    </div>

    <script type="module">
      import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

      const SUPABASE_URL = "https://prteyzbjjzkfyogphwrg.supabase.co";
      const SUPABASE_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBydGV5emJqanprZnlvZ3Bod3JnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0ODI0MTYsImV4cCI6MjA4NTA1ODQxNn0.VWJS8IcAhXSucmgQiOw9fpl79apwCYOmTdaC31_Invw";

      const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
      window.supabase = supabase;

      const statusBox = document.getElementById("status");
      const loginBox = document.getElementById("loginBox");
      const adminBox = document.getElementById("adminBox");
      const addBtn = document.getElementById("addBtn");

      const emailEl = document.getElementById("email");
      const passEl = document.getElementById("password");
      const nameEl = document.getElementById("name");
      const priceEl = document.getElementById("price");
      const descEl = document.getElementById("description");
      const imageEl = document.getElementById("image");
      const itemsEl = document.getElementById("items");

      const brandInput = document.getElementById("brandInput");
      const sloganInput = document.getElementById("sloganInput");
      const logoInput = document.getElementById("logoInput");
      const saveBrandingBtn = document.getElementById("saveBrandingBtn");

      const brandLogo = document.getElementById("brandLogo");
      const brandTitle = document.getElementById("brandTitle");
      const brandSlogan = document.getElementById("brandSlogan");

      const BRANDING_ID = "11327357-0269-422d-ae06-3f3835868e85";


      let editingItemId = null;

      let statusTimeout;

      const logoPreview = document.getElementById("logoPreview");

logoInput.onchange = () => {
  if (!logoInput.files[0]) return;
  logoPreview.src = URL.createObjectURL(logoInput.files[0]);
  logoPreview.style.display = "block";
};




      async function loadBranding() {
        const { data, error } = await supabase
          .from("menu_settings")
          .select("*")
          .eq("id", BRANDING_ID)
          .single();

        if (error) {
          console.error(error);
          return;
        }

        brandInput.value = data.brand || "";
        sloganInput.value = data.slogan || "";

        brandTitle.textContent = data.brand || "Admin";
        brandSlogan.textContent = data.slogan || "";

        if (data.logo_url) {
          brandLogo.src = data.logo_url + "?t=" + Date.now();
        }
      }

      

      saveBrandingBtn.onclick = async () => {
  try {
    saveBrandingBtn.disabled = true;
    showStatus("Saving brandingâ€¦");

    // 1ï¸âƒ£ Load existing branding (to get old logo path)
    const { data: existing, error: fetchErr } = await supabase
      .from("menu_settings")
      .select("logo_path")
      .eq("id", BRANDING_ID)
      .single();

    if (fetchErr) throw fetchErr;

    let logo_path = existing.logo_path || null;
    let logo_url = null;

    // 2ï¸âƒ£ If uploading a new logo
    if (logoInput.files[0]) {
      const file = logoInput.files[0];

      // ðŸ”¥ Delete old logo FIRST
      if (logo_path) {
        await supabase.storage
          .from("menu-images")
          .remove([logo_path]);
      }

      // ðŸ”’ Unique filename (prevents cache hell)
      logo_path = `logo/brand-${Date.now()}.jpg`;

      const upload = await supabase.storage
        .from("menu-images")
        .upload(logo_path, file, {
          contentType: file.type,
          upsert: false,
        });

      if (upload.error) throw upload.error;

      const { data: pub } = supabase.storage
        .from("menu-images")
        .getPublicUrl(logo_path);

      logo_url = pub.publicUrl;
    }

    // 3ï¸âƒ£ Update DB
    const { error } = await supabase
      .from("menu_settings")
      .update({
        brand: brandInput.value.trim(),
        slogan: sloganInput.value.trim(),
        ...(logo_path && logo_url
          ? { logo_path, logo_url }
          : {}),
        updated_at: new Date().toISOString(),
      })
      .eq("id", BRANDING_ID);

    if (error) throw error;

    showStatus("Branding updated successfully");
    logoInput.value = "";
    logoPreview.style.display = "none";
    loadBranding();
  } catch (err) {
    console.error(err);
    showStatus("Failed to save branding", false);
  } finally {
    saveBrandingBtn.disabled = false;
  }
};


      function showStatus(msg, ok = true, duration = 3000) {
        if (statusTimeout) clearTimeout(statusTimeout);

        statusBox.innerHTML = msg;
        statusBox.className = `status ${ok ? "ok" : "err"} show`;

        statusTimeout = setTimeout(() => {
          statusBox.classList.remove("show");
        }, duration);
      }

      function setLoading(isLoading, text = "Processing...") {
        addBtn.disabled = isLoading;
        addBtn.innerHTML = isLoading
          ? `<span class="loading"><span class="spinner"></span>${text}</span>`
          : "Add Item";
      }

      supabase.auth.onAuthStateChange((_event, session) => {
        const logoutBtn = document.getElementById("logoutBtn");

        if (session) {
          logoutBtn.style.display = "inline-flex";
          loginBox.style.display = "none";
          adminBox.style.display = "block";
          loadItems();
          loadBranding();
        } else {
          logoutBtn.style.display = "none";
          loginBox.style.display = "block";
          adminBox.style.display = "none";
        }
      });

      // AUTH
      async function checkSession() {
        const { data } = await supabase.auth.getSession();
        const logoutBtn = document.getElementById("logoutBtn");

        if (data.session) {
          // Logged in
          logoutBtn.style.display = "inline-flex";
          loginBox.style.display = "none";
          adminBox.style.display = "block";
          loadItems();
        } else {
          // Logged out
          logoutBtn.style.display = "none";
          loginBox.style.display = "block";
          adminBox.style.display = "none";
        }
      }

      document.getElementById("loginBtn").onclick = async () => {
        const { error } = await supabase.auth.signInWithPassword({
          email: emailEl.value.trim(),
          password: passEl.value.trim(),
        });
        error ? showStatus(error.message, false) : checkSession();
      };

      // ================================
      // LOGOUT CONFIRMATION
      // ================================

      document.getElementById("logoutBtn").onclick = () => {
        document.getElementById("logoutModal").classList.add("show");
      };

      document.getElementById("cancelLogout").onclick = () => {
        document.getElementById("logoutModal").classList.remove("show");
      };

      document.getElementById("confirmLogout").onclick = async () => {
        document.getElementById("logoutModal").classList.remove("show");

        await supabase.auth.signOut();
        showStatus("Logged out");
      };

      // LOAD
      async function loadItems() {
        const { data } = await supabase
          .from("menu_items")
          .select("*")
          .order("created_at", { ascending: false });

        itemsEl.innerHTML = data
          .map(
            (i) => `
    <div class="item">
      <img src="${i.image_url}" />
      <div class="item-info">
        <strong>${i.name}</strong>
        <div class="price">â‚±${i.price}</div>
        <div class="desc">${i.description || ""}</div>
      </div>
      <div class="item-actions" style="display:flex; gap:8px; margin-top:8px;">
  <button onclick="startEditItem('${i.id}')">Edit</button>
  <button class="danger" onclick="deleteItem('${i.id}')">Delete</button>
</div>

    </div>
  `,
          )
          .join("");
      }

      let oldImagePath = null;

      window.startEditItem = async (id) => {
        const { data, error } = await supabase
          .from("menu_items")
          .select("*")
          .eq("id", id)
          .single();

        if (error) {
          showStatus("Failed to load item", false);
          return;
        }

        nameEl.value = data.name;
        priceEl.value = data.price;
        descEl.value = data.description || "";

        editingItemId = id;
        oldImagePath = data.image_path; // ðŸ‘ˆ store old image
        addBtn.textContent = "Update Item";

        showStatus("Editing item");
      };

      // ================================
      // DELETE ITEM (GLASS CONFIRM)
      // ================================

      let pendingDeleteId = null;

      // Called when user clicks Delete button
      window.deleteItem = (id) => {
        pendingDeleteId = id;
        document.getElementById("confirmModal").classList.add("show");
      };

      // Cancel delete
      document.getElementById("cancelDelete").onclick = () => {
        pendingDeleteId = null;
        document.getElementById("confirmModal").classList.remove("show");
      };

      // Confirm delete
      document.getElementById("confirmDelete").onclick = async () => {
        document.getElementById("confirmModal").classList.remove("show");
        await actuallyDeleteItem(pendingDeleteId);
      };

      // Actual delete logic
      async function actuallyDeleteItem(id) {
        if (!id) return;

        try {
          showStatus("Deleting itemâ€¦");

          // 1ï¸âƒ£ Fetch item to get image path
          const { data: item, error: fetchError } = await supabase
            .from("menu_items")
            .select("image_path")
            .eq("id", id)
            .single();

          if (fetchError) throw fetchError;

          // 2ï¸âƒ£ Delete image from storage (if exists)
          if (item.image_path) {
            const { error: storageError } = await supabase.storage
              .from("menu-images")
              .remove([item.image_path]);

            if (storageError) throw storageError;
          }

          // 3ï¸âƒ£ Delete database record
          const { error: deleteError } = await supabase
            .from("menu_items")
            .delete()
            .eq("id", id);

          if (deleteError) throw deleteError;

          showStatus("Item deleted successfully");
          loadItems();
        } catch (err) {
          console.error(err);
          showStatus("Failed to delete item properly", false);
        } finally {
          pendingDeleteId = null;
        }
      }

      // ================================
      // IMAGE RESIZE BEFORE UPLOAD
      // ================================
      async function resizeImage(file, maxWidth = 1500, quality = 0.8) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          const img = new Image();

          reader.onload = (e) => (img.src = e.target.result);
          reader.onerror = reject;

          img.onload = () => {
            const scale = Math.min(1, maxWidth / img.width);
            const width = Math.round(img.width * scale);
            const height = Math.round(img.height * scale);

            const canvas = document.createElement("canvas");
            canvas.width = width;
            canvas.height = height;

            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, width, height);

            canvas.toBlob(
              (blob) => {
                if (!blob) return reject(new Error("Image resize failed"));
                resolve(blob);
              },
              "image/jpeg",
              quality,
            );
          };

          img.onerror = reject;
          reader.readAsDataURL(file);
        });
      }

      // ADD
      addBtn.onclick = async () => {
        try {
          if (!nameEl.value || !priceEl.value)
            throw new Error("Name and price are required");

          const isEditing = !!editingItemId;

          setLoading(true, isEditing ? "Updating..." : "Adding...");

          let image_url = null;
          let image_path = null;

          // If uploading a NEW image
          if (imageEl.files[0]) {
            showStatus("Optimizing imageâ€¦");
            const resizedBlob = await resizeImage(imageEl.files[0], 1500, 0.8);

            const file = new File([resizedBlob], "menu.jpg", {
              type: "image/jpeg",
            });

            const safeName = nameEl.value
              .toLowerCase()
              .replace(/[^a-z0-9]/g, "-");

            image_path = `items/${safeName}-${Date.now()}.jpg`;

            const upload = await supabase.storage
              .from("menu-images")
              .upload(image_path, file);

            if (upload.error) throw upload.error;

            const { data: img } = supabase.storage
              .from("menu-images")
              .getPublicUrl(image_path);

            image_url = img.publicUrl;
          }

          if (isEditing) {
            const updateData = {
              name: nameEl.value,
              price: priceEl.value,
              description: descEl.value,
            };

            if (image_url) {
              updateData.image_url = image_url;
              updateData.image_path = image_path;
            }

            const { error } = await supabase
              .from("menu_items")
              .update(updateData)
              .eq("id", editingItemId);

            if (error) throw error;

            // ðŸ”¥ DELETE OLD IMAGE SAFELY
            if (image_url && oldImagePath) {
              await supabase.storage.from("menu-images").remove([oldImagePath]);
            }

            showStatus("Item updated");
          } else {
            // âž• INSERT
            if (!image_url) throw new Error("Image is required");

            const { error } = await supabase.from("menu_items").insert({
              name: nameEl.value,
              price: priceEl.value,
              description: descEl.value,
              image_url,
              image_path,
            });

            if (error) throw error;

            showStatus("Item added");
          }

          // Reset form
          nameEl.value = priceEl.value = descEl.value = imageEl.value = "";
          editingItemId = null;
          oldImagePath = null;
          addBtn.textContent = "Add Item";

          loadItems();
        } catch (err) {
          showStatus(err.message, false);
        } finally {
          setLoading(false);
        }
      };

      checkSession();
    </script>
  </body>
</html>
