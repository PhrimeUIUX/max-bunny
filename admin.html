<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Menu Admin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="stylesheet" href="style/admin.css" />
  </head>

  <body>
    <div class="container">
      <div class="topbar">
        <button
          style="
            width: fit-content;
            font-weight: 400;
            align-self: flex-end;
            display: none;
          "
          id="logoutBtn"
          class="secondary"
        >
          Logout
        </button>
        <div
          style="
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
          "
        >
          <img
            src="https://prteyzbjjzkfyogphwrg.supabase.co/storage/v1/object/public/menu-images/logo/maxbunny.jpg"
            alt="max and bunny logo"
            style="border-radius: 1000px"
          />
          <h1>Admin</h1>
          <p>Manage your restaurant menu</p>
        </div>
      </div>

      <div id="status"></div>

      <!-- LOGIN -->
      <div id="loginBox" class="card">
        <h2>Admin Login</h2>
        <div class="row">
          <input id="email" placeholder="Email" />
          <input id="password" type="password" placeholder="Password" />
          <button id="loginBtn">Sign in</button>
        </div>
      </div>

      <!-- ADMIN -->
      <div id="adminBox" style="display: none">
        <div class="card">
          <h2>Add Menu Item</h2>
          <div class="row row-2">
            <input id="name" placeholder="Item name" />
            <input id="price" type="number" placeholder="Price (â‚±)" />
          </div>
          <div style="width: 100%; height: 14px"></div>
          <div class="row">
            <textarea
              id="description"
              placeholder="Item description"
            ></textarea>
            <input id="image" type="file" />
            <button id="addBtn">Add Item</button>
          </div>
        </div>

        <div class="card">
          <h2>Menu Items</h2>
          <div id="items"></div>
        </div>
      </div>
    </div>

    <script type="module">
      import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

      const SUPABASE_URL = "https://prteyzbjjzkfyogphwrg.supabase.co";
      const SUPABASE_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBydGV5emJqanprZnlvZ3Bod3JnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0ODI0MTYsImV4cCI6MjA4NTA1ODQxNn0.VWJS8IcAhXSucmgQiOw9fpl79apwCYOmTdaC31_Invw";

      const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
      window.supabase = supabase;

      const statusBox = document.getElementById("status");
      const loginBox = document.getElementById("loginBox");
      const adminBox = document.getElementById("adminBox");
      const addBtn = document.getElementById("addBtn");

      const emailEl = document.getElementById("email");
      const passEl = document.getElementById("password");
      const nameEl = document.getElementById("name");
      const priceEl = document.getElementById("price");
      const descEl = document.getElementById("description");
      const imageEl = document.getElementById("image");
      const itemsEl = document.getElementById("items");

      function showStatus(msg, ok = true) {
        statusBox.className = `status ${ok ? "ok" : "err"}`;
        statusBox.innerHTML = msg;
      }

      function setLoading(isLoading, text = "Processing...") {
        addBtn.disabled = isLoading;
        addBtn.innerHTML = isLoading
          ? `<span class="loading"><span class="spinner"></span>${text}</span>`
          : "Add Item";
      }

      supabase.auth.onAuthStateChange((_event, session) => {
        const logoutBtn = document.getElementById("logoutBtn");

        if (session) {
          logoutBtn.style.display = "inline-flex";
          loginBox.style.display = "none";
          adminBox.style.display = "block";
          loadItems();
        } else {
          logoutBtn.style.display = "none";
          loginBox.style.display = "block";
          adminBox.style.display = "none";
        }
      });

      // AUTH
      async function checkSession() {
        const { data } = await supabase.auth.getSession();
        const logoutBtn = document.getElementById("logoutBtn");

        if (data.session) {
          // Logged in
          logoutBtn.style.display = "inline-flex";
          loginBox.style.display = "none";
          adminBox.style.display = "block";
          loadItems();
        } else {
          // Logged out
          logoutBtn.style.display = "none";
          loginBox.style.display = "block";
          adminBox.style.display = "none";
        }
      }

      document.getElementById("loginBtn").onclick = async () => {
        const { error } = await supabase.auth.signInWithPassword({
          email: emailEl.value.trim(),
          password: passEl.value.trim(),
        });
        error ? showStatus(error.message, false) : checkSession();
      };

      document.getElementById("logoutBtn").onclick = async () => {
        await supabase.auth.signOut();
        showStatus("Logged out");
        checkSession();
      };

      // LOAD
      async function loadItems() {
        const { data } = await supabase
          .from("menu_items")
          .select("*")
          .order("created_at", { ascending: false });

        itemsEl.innerHTML = data
          .map(
            (i) => `
    <div class="item">
      <img src="${i.image_url}" />
      <div class="item-info">
        <strong>${i.name}</strong>
        <div class="price">â‚±${i.price}</div>
        <div class="desc">${i.description || ""}</div>
      </div>
      <button class="danger" onclick="deleteItem('${i.id}')">Delete</button>
    </div>
  `,
          )
          .join("");
      }

      window.deleteItem = async (id) => {
        if (!confirm("Delete item? This cannot be undone.")) return;

        try {
          showStatus("Deleting itemâ€¦");

          // 1. Fetch item first
          const { data: item, error: fetchError } = await supabase
            .from("menu_items")
            .select("image_path")
            .eq("id", id)
            .single();

          if (fetchError) throw fetchError;

          // 2. Delete image from storage (if exists)
          if (item.image_path) {
            const { error: storageError } = await supabase.storage
              .from("menu-images")
              .remove([item.image_path]);

            if (storageError) throw storageError;
          }

          // 3. Delete database record
          const { error: deleteError } = await supabase
            .from("menu_items")
            .delete()
            .eq("id", id);

          if (deleteError) throw deleteError;

          showStatus("Item deleted successfully");
          loadItems();
        } catch (err) {
          console.error(err);
          showStatus("Failed to delete item properly", false);
        }
      };

      // ADD
      addBtn.onclick = async () => {
        try {
          if (!nameEl.value || !priceEl.value || !imageEl.files[0])
            throw new Error("All required fields must be filled");

          setLoading(true, "Uploading image...");
          showStatus("Uploading imageâ€¦");

          const file = imageEl.files[0];
          const path = `items/${Date.now()}-${file.name}`;

          const upload = await supabase.storage
            .from("menu-images")
            .upload(path, file);
          if (upload.error) throw upload.error;

          showStatus("Saving itemâ€¦");
          setLoading(true, "Saving item...");

          const { data: img } = supabase.storage
            .from("menu-images")
            .getPublicUrl(path);

          const insert = await supabase.from("menu_items").insert({
            name: nameEl.value,
            price: priceEl.value,
            description: descEl.value,
            image_url: img.publicUrl,
            image_path: path, // ðŸ‘ˆ critical
          });

          if (insert.error) throw insert.error;

          nameEl.value = priceEl.value = descEl.value = imageEl.value = "";
          showStatus("Item added successfully");
          loadItems();
        } catch (err) {
          showStatus(err.message, false);
        } finally {
          setLoading(false);
        }
      };

      checkSession();
    </script>
  </body>
</html>
