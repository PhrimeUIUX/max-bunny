<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Menu Admin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@600;700;800&display=swap"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="style/admin.css"/>
    
  </head>

  <body>
    <!-- LOGIN SCREEN -->
    <div id="loginScreen">
      <div class="login-card">
        <img id="loginLogo" src="https://prteyzbjjzkfyogphwrg.supabase.co/storage/v1/object/public/menu-images/KioskBrand/WebKiosk.jpg" alt="Brand logo" />
        <h1 id="loginBrand">Web Kiosk</h1>
        <p id="loginSlogan">Sign in to manage your menu</p>
        <input
          id="email"
          type="email"
          placeholder="Email"
          autocomplete="email"
        />
        <input
          id="password"
          type="password"
          placeholder="Password"
          autocomplete="current-password"
        />
        <button id="loginBtn">Sign in</button>
      </div>
    </div>

    <!-- DASHBOARD SCREEN -->
    <div id="dashboardScreen">
      <div class="dashboard-container">
        <!-- SIDEBAR -->
        <aside class="sidebar">
          <div class="sidebar-brand">
            <img id="sidebarLogo" src="" alt="Brand logo" />
            <div class="sidebar-brand-text">
              <h2 id="sidebarBrand">Admin</h2>
              <p id="sidebarSlogan">Dashboard</p>
            </div>
          </div>

          <nav class="sidebar-nav">
            <div class="nav-item active" data-section="menu">
              <svg
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"
                ></path>
              </svg>
              Menu Items
            </div>
            <div class="nav-item" data-section="branding">
              <svg
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"
                ></path>
              </svg>
              Branding
            </div>
          </nav>

          <div class="sidebar-footer">
            <button class="logout-btn" id="logoutBtn">
              <svg
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                xmlns="http://www.w3.org/2000/svg"
                style="width: 18px; height: 18px"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
                ></path>
              </svg>
              Logout
            </button>
          </div>
        </aside>

        <!-- MAIN CONTENT -->
        <div class="main-content">
          <header class="header">
            <h1 id="headerTitle">Menu Items</h1>
            <div class="header-actions">
              <button class="btn btn-primary" id="addItemBtn">
                <svg
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  xmlns="http://www.w3.org/2000/svg"
                  style="width: 18px; height: 18px"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 4v16m8-8H4"
                  ></path>
                </svg>
                Add Item
              </button>
            </div>
          </header>

          <main class="content-area">
            <!-- MENU ITEMS SECTION -->
            <section class="section active" id="menuSection">
              <div class="table-container">
                <table class="table">
                  <thead>
                    <tr>
                      <th style="width: 72px">Image</th>
                      <th>Name</th>
                      <th style="width: 120px">Price</th>
                      <th>Description</th>
                      <th style="width: 100px">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="menuTableBody">
                    <!-- Items will be inserted here -->
                  </tbody>
                </table>
                <div id="emptyState" class="empty-state" style="display: none">
                  <svg
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"
                    ></path>
                  </svg>
                  <h3>No menu items yet</h3>
                  <p>Get started by adding your first menu item</p>
                </div>
              </div>
            </section>

            <!-- BRANDING SECTION -->
            <section class="section" id="brandingSection">
              <div class="branding-card">
                <div class="branding-preview">
                  <img id="brandingPreviewLogo" src="" alt="Logo preview" />
                  <h3 id="brandingPreviewName">Your Brand</h3>
                  <p id="brandingPreviewSlogan">Your slogan here</p>
                </div>

                <div class="form-group">
                  <label class="form-label">Brand Name</label>
                  <input
                    type="text"
                    class="form-input"
                    id="brandNameInput"
                    placeholder="Enter brand name"
                  />
                </div>

                <div class="form-group">
                  <label class="form-label">Slogan</label>
                  <input
                    type="text"
                    class="form-input"
                    id="brandSloganInput"
                    placeholder="Enter slogan"
                  />
                </div>

                <div class="form-group">
                  <label class="form-label">Logo</label>
                  <div class="form-file-upload">
                    <input
                      type="file"
                      class="form-file-input"
                      id="brandLogoInput"
                      accept="image/*"
                    />
                    <label for="brandLogoInput" class="form-file-label">
                      <svg
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
                        ></path>
                      </svg>
                      <p><span>Click to upload</span> or drag and drop</p>
                    </label>
                    <div id="brandLogoPreview" class="image-preview"></div>
                  </div>
                </div>

                <button class="btn btn-primary" id="saveBrandingBtn">
                  Save Branding
                </button>
              </div>
            </section>
          </main>
        </div>
      </div>
    </div>

    <!-- ITEM MODAL -->
    <div id="itemModal" class="modal-backdrop">
      <div class="modal">
        <div class="modal-header">
          <h2 id="modalTitle">Add Menu Item</h2>
        </div>
        <div class="modal-body">
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Item Name</label>
              <input
                type="text"
                class="form-input"
                id="itemName"
                placeholder="e.g., Margherita Pizza"
              />
            </div>
            <div class="form-group">
              <label class="form-label">Price (₱)</label>
              <input
                type="number"
                class="form-input"
                id="itemPrice"
                placeholder="0.00"
                step="0.01"
              />
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Description</label>
            <textarea
              class="form-textarea"
              id="itemDescription"
              placeholder="Describe your menu item..."
            ></textarea>
          </div>

          <div class="form-group">
            <label class="form-label">Image</label>
            <div class="form-file-upload">
              <input
                type="file"
                class="form-file-input"
                id="itemImage"
                accept="image/*"
              />
              <label for="itemImage" class="form-file-label">
                <svg
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
                  ></path>
                </svg>
                <p><span>Click to upload</span> or drag and drop</p>
              </label>
              <div id="itemImagePreview" class="image-preview"></div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" id="cancelItemBtn">Cancel</button>
          <button class="btn btn-primary" id="saveItemBtn">Save Item</button>
        </div>
      </div>
    </div>

    <!-- DELETE CONFIRM MODAL -->
    <div id="deleteModal" class="modal-backdrop">
      <div class="modal confirm-dialog">
        <div class="modal-body">
          <h3>Delete menu item?</h3>
          <p>This action cannot be undone.</p>
          <div class="confirm-actions">
            <button class="btn btn-secondary" id="cancelDeleteBtn">
              Cancel
            </button>
            <button class="btn btn-danger" id="confirmDeleteBtn">
              Delete
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- LOGOUT CONFIRM MODAL -->
    <div id="logoutModal" class="modal-backdrop">
      <div class="modal confirm-dialog">
        <div class="modal-body">
          <h3>Log out?</h3>
          <p>You'll need to sign in again to manage the menu.</p>
          <div class="confirm-actions">
            <button class="btn btn-secondary" id="cancelLogoutBtn">
              Cancel
            </button>
            <button class="btn btn-danger" id="confirmLogoutBtn">
              Log out
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- STATUS TOAST -->
    <div id="statusToast" class="status-toast">
      <svg
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M5 13l4 4L19 7"
        ></path>
      </svg>
      <div class="status-toast-content">
        <p id="statusMessage">Success</p>
      </div>
    </div>

    <script type="module">
      import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

      const SUPABASE_URL = "https://prteyzbjjzkfyogphwrg.supabase.co";
      const SUPABASE_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBydGV5emJqanprZnlvZ3Bod3JnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0ODI0MTYsImV4cCI6MjA4NTA1ODQxNn0.VWJS8IcAhXSucmgQiOw9fpl79apwCYOmTdaC31_Invw";

      const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
      const BRANDING_ID = "11327357-0269-422d-ae06-3f3835868e85";

      // State
      let editingItemId = null;
      let oldImagePath = null;
      let pendingDeleteId = null;
      let statusTimeout;

      // Elements
      const loginScreen = document.getElementById("loginScreen");
      const dashboardScreen = document.getElementById("dashboardScreen");

      const emailEl = document.getElementById("email");
      const passwordEl = document.getElementById("password");
      const loginBtn = document.getElementById("loginBtn");

      const menuTableBody = document.getElementById("menuTableBody");
      const emptyState = document.getElementById("emptyState");

      const itemModal = document.getElementById("itemModal");
      const modalTitle = document.getElementById("modalTitle");
      const itemName = document.getElementById("itemName");
      const itemPrice = document.getElementById("itemPrice");
      const itemDescription = document.getElementById("itemDescription");
      const itemImage = document.getElementById("itemImage");
      const itemImagePreview = document.getElementById("itemImagePreview");
      const saveItemBtn = document.getElementById("saveItemBtn");
      const cancelItemBtn = document.getElementById("cancelItemBtn");

      const deleteModal = document.getElementById("deleteModal");
      const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");
      const cancelDeleteBtn = document.getElementById("cancelDeleteBtn");

      const logoutModal = document.getElementById("logoutModal");
      const logoutBtn = document.getElementById("logoutBtn");
      const confirmLogoutBtn = document.getElementById("confirmLogoutBtn");
      const cancelLogoutBtn = document.getElementById("cancelLogoutBtn");

      const brandNameInput = document.getElementById("brandNameInput");
      const brandSloganInput = document.getElementById("brandSloganInput");
      const brandLogoInput = document.getElementById("brandLogoInput");
      const brandLogoPreview = document.getElementById("brandLogoPreview");
      const saveBrandingBtn = document.getElementById("saveBrandingBtn");

      const statusToast = document.getElementById("statusToast");
      const statusMessage = document.getElementById("statusMessage");

      // ============================================
      // NAVIGATION
      // ============================================

      document.querySelectorAll(".nav-item").forEach((item) => {
        item.addEventListener("click", () => {
          const section = item.dataset.section;

          // Update nav active state
          document.querySelectorAll(".nav-item").forEach((n) => {
            n.classList.remove("active");
          });
          item.classList.add("active");

          // Update sections
          document.querySelectorAll(".section").forEach((s) => {
            s.classList.remove("active");
          });

          if (section === "menu") {
            document.getElementById("menuSection").classList.add("active");
            document.getElementById("headerTitle").textContent = "Menu Items";
            document.getElementById("addItemBtn").style.display = "flex";
          } else if (section === "branding") {
            document.getElementById("brandingSection").classList.add("active");
            document.getElementById("headerTitle").textContent = "Branding";
            document.getElementById("addItemBtn").style.display = "none";
          }
        });
      });

      // ============================================
      // STATUS TOAST
      // ============================================

      function showStatus(message, isSuccess = true, duration = 3000) {
        if (statusTimeout) clearTimeout(statusTimeout);

        statusMessage.textContent = message;
        statusToast.className = `status-toast ${isSuccess ? "success" : "error"} show`;

        statusTimeout = setTimeout(() => {
          statusToast.classList.remove("show");
        }, duration);
      }

      // ============================================
      // AUTH
      // ============================================

      supabase.auth.onAuthStateChange((_event, session) => {
        if (session) {
          loginScreen.style.display = "none";
          dashboardScreen.style.display = "block";
          loadItems();
          loadBranding();
        } else {
          loginScreen.style.display = "flex";
          dashboardScreen.style.display = "none";
        }
      });

      async function checkSession() {
        const { data } = await supabase.auth.getSession();
        if (data.session) {
          loginScreen.style.display = "none";
          dashboardScreen.style.display = "block";
          loadItems();
          loadBranding();
        }
      }

      loginBtn.addEventListener("click", async () => {
        const { error } = await supabase.auth.signInWithPassword({
          email: emailEl.value.trim(),
          password: passwordEl.value.trim(),
        });

        if (error) {
          showStatus(error.message, false);
        } else {
          checkSession();
        }
      });

      logoutBtn.addEventListener("click", () => {
        logoutModal.classList.add("show");
      });

      cancelLogoutBtn.addEventListener("click", () => {
        logoutModal.classList.remove("show");
      });

      confirmLogoutBtn.addEventListener("click", async () => {
        logoutModal.classList.remove("show");
        await supabase.auth.signOut();
        showStatus("Logged out successfully");
      });

      // ============================================
      // BRANDING
      // ============================================

      async function loadBranding() {
        const { data, error } = await supabase
          .from("menu_settings")
          .select("*")
          .eq("id", BRANDING_ID)
          .single();

        if (error) {
          console.error(error);
          return;
        }

        const brandName = data.brand || "Admin";
        const slogan = data.slogan || "Dashboard";
        const logoUrl = data.logo_url
          ? data.logo_url + "?t=" + Date.now()
          : "";

        // Update all brand elements
        brandNameInput.value = brandName;
        brandSloganInput.value = slogan;

        document.getElementById("loginBrand").textContent = brandName;
        document.getElementById("loginSlogan").textContent =
          slogan || "Sign in to manage your menu";
        document.getElementById("sidebarBrand").textContent = brandName;
        document.getElementById("sidebarSlogan").textContent = slogan;
        document.getElementById("brandingPreviewName").textContent = brandName;
        document.getElementById("brandingPreviewSlogan").textContent = slogan;

        if (logoUrl) {
          document.getElementById("loginLogo").src = logoUrl;
          document.getElementById("sidebarLogo").src = logoUrl;
          document.getElementById("brandingPreviewLogo").src = logoUrl;
        }
      }

      brandLogoInput.addEventListener("change", () => {
        if (!brandLogoInput.files[0]) return;

        const file = brandLogoInput.files[0];
        const reader = new FileReader();

        reader.onload = (e) => {
          brandLogoPreview.innerHTML = `<img src="${e.target.result}" alt="Preview" />`;
        };

        reader.readAsDataURL(file);
      });

      saveBrandingBtn.addEventListener("click", async () => {
        try {
          saveBrandingBtn.disabled = true;
          saveBrandingBtn.innerHTML =
            '<span class="spinner"></span> Saving...';

          const { data: existing, error: fetchErr } = await supabase
            .from("menu_settings")
            .select("logo_path")
            .eq("id", BRANDING_ID)
            .single();

          if (fetchErr) throw fetchErr;

          let logo_path = existing.logo_path || null;
          let logo_url = null;

          if (brandLogoInput.files[0]) {
            const file = brandLogoInput.files[0];

            if (logo_path) {
              await supabase.storage.from("menu-images").remove([logo_path]);
            }

            logo_path = `logo/brand-${Date.now()}.jpg`;

            const upload = await supabase.storage
              .from("menu-images")
              .upload(logo_path, file, {
                contentType: file.type,
                upsert: false,
              });

            if (upload.error) throw upload.error;

            const { data: pub } = supabase.storage
              .from("menu-images")
              .getPublicUrl(logo_path);

            logo_url = pub.publicUrl;
          }

          const { error } = await supabase
            .from("menu_settings")
            .update({
              brand: brandNameInput.value.trim(),
              slogan: brandSloganInput.value.trim(),
              ...(logo_path && logo_url ? { logo_path, logo_url } : {}),
              updated_at: new Date().toISOString(),
            })
            .eq("id", BRANDING_ID);

          if (error) throw error;

          showStatus("Branding updated successfully");
          brandLogoInput.value = "";
          brandLogoPreview.innerHTML = "";
          loadBranding();
        } catch (err) {
          console.error(err);
          showStatus("Failed to save branding", false);
        } finally {
          saveBrandingBtn.disabled = false;
          saveBrandingBtn.textContent = "Save Branding";
        }
      });

      // ============================================
      // MENU ITEMS
      // ============================================

      async function loadItems() {
        const { data, error } = await supabase
          .from("menu_items")
          .select("*")
          .order("created_at", { ascending: false });

        if (error) {
          console.error(error);
          return;
        }

        if (!data || data.length === 0) {
          menuTableBody.innerHTML = "";
          emptyState.style.display = "block";
          return;
        }

        emptyState.style.display = "none";

        menuTableBody.innerHTML = data
          .map(
            (item) => `
          <tr>
            <td><img src="${item.image_url}" alt="${item.name}" class="table-image" /></td>
            <td class="table-name">${item.name}</td>
            <td class="table-price">₱${parseFloat(item.price).toFixed(2)}</td>
            <td class="table-description">${item.description || ""}</td>
            <td>
              <div class="table-actions">
                <button class="btn-icon" onclick="editItem('${item.id}')">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                  </svg>
                </button>
                <button class="btn-icon danger" onclick="deleteItem('${item.id}')">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                  </svg>
                </button>
              </div>
            </td>
          </tr>
        `,
          )
          .join("");
      }

      document.getElementById("addItemBtn").addEventListener("click", () => {
        editingItemId = null;
        oldImagePath = null;
        modalTitle.textContent = "Add Menu Item";
        saveItemBtn.textContent = "Save Item";

        itemName.value = "";
        itemPrice.value = "";
        itemDescription.value = "";
        itemImage.value = "";
        itemImagePreview.innerHTML = "";

        itemModal.classList.add("show");
      });

      window.editItem = async (id) => {
        const { data, error } = await supabase
          .from("menu_items")
          .select("*")
          .eq("id", id)
          .single();

        if (error) {
          showStatus("Failed to load item", false);
          return;
        }

        editingItemId = id;
        oldImagePath = data.image_path;
        modalTitle.textContent = "Edit Menu Item";
        saveItemBtn.textContent = "Update Item";

        itemName.value = data.name;
        itemPrice.value = data.price;
        itemDescription.value = data.description || "";
        itemImage.value = "";
        itemImagePreview.innerHTML = `<img src="${data.image_url}" alt="Current image" />`;

        itemModal.classList.add("show");
      };

      itemImage.addEventListener("change", () => {
        if (!itemImage.files[0]) return;

        const file = itemImage.files[0];
        const reader = new FileReader();

        reader.onload = (e) => {
          itemImagePreview.innerHTML = `<img src="${e.target.result}" alt="Preview" />`;
        };

        reader.readAsDataURL(file);
      });

      cancelItemBtn.addEventListener("click", () => {
        itemModal.classList.remove("show");
      });

      saveItemBtn.addEventListener("click", async () => {
        try {
          if (!itemName.value || !itemPrice.value) {
            throw new Error("Name and price are required");
          }

          const isEditing = !!editingItemId;

          saveItemBtn.disabled = true;
          saveItemBtn.innerHTML = `<span class="spinner"></span> ${isEditing ? "Updating..." : "Saving..."}`;

          let image_url = null;
          let image_path = null;

          if (itemImage.files[0]) {
            const resizedBlob = await resizeImage(itemImage.files[0], 1500, 0.8);
            const file = new File([resizedBlob], "menu.jpg", {
              type: "image/jpeg",
            });

            const safeName = itemName.value
              .toLowerCase()
              .replace(/[^a-z0-9]/g, "-");
            image_path = `items/${safeName}-${Date.now()}.jpg`;

            const upload = await supabase.storage
              .from("menu-images")
              .upload(image_path, file);

            if (upload.error) throw upload.error;

            const { data: img } = supabase.storage
              .from("menu-images")
              .getPublicUrl(image_path);

            image_url = img.publicUrl;
          }

          if (isEditing) {
            const updateData = {
              name: itemName.value,
              price: itemPrice.value,
              description: itemDescription.value,
            };

            if (image_url) {
              updateData.image_url = image_url;
              updateData.image_path = image_path;
            }

            const { error } = await supabase
              .from("menu_items")
              .update(updateData)
              .eq("id", editingItemId);

            if (error) throw error;

            if (image_url && oldImagePath) {
              await supabase.storage.from("menu-images").remove([oldImagePath]);
            }

            showStatus("Item updated successfully");
          } else {
            if (!image_url) throw new Error("Image is required");

            const { error } = await supabase.from("menu_items").insert({
              name: itemName.value,
              price: itemPrice.value,
              description: itemDescription.value,
              image_url,
              image_path,
            });

            if (error) throw error;

            showStatus("Item added successfully");
          }

          itemModal.classList.remove("show");
          loadItems();
        } catch (err) {
          showStatus(err.message, false);
        } finally {
          saveItemBtn.disabled = false;
          saveItemBtn.textContent = editingItemId ? "Update Item" : "Save Item";
        }
      });

      window.deleteItem = (id) => {
        pendingDeleteId = id;
        deleteModal.classList.add("show");
      };

      cancelDeleteBtn.addEventListener("click", () => {
        deleteModal.classList.remove("show");
        pendingDeleteId = null;
      });

      confirmDeleteBtn.addEventListener("click", async () => {
        if (!pendingDeleteId) return;

        try {
          confirmDeleteBtn.disabled = true;
          confirmDeleteBtn.innerHTML =
            '<span class="spinner"></span> Deleting...';

          const { data: item, error: fetchError } = await supabase
            .from("menu_items")
            .select("image_path")
            .eq("id", pendingDeleteId)
            .single();

          if (fetchError) throw fetchError;

          if (item.image_path) {
            const { error: storageError } = await supabase.storage
              .from("menu-images")
              .remove([item.image_path]);

            if (storageError) throw storageError;
          }

          const { error: deleteError } = await supabase
            .from("menu_items")
            .delete()
            .eq("id", pendingDeleteId);

          if (deleteError) throw deleteError;

          showStatus("Item deleted successfully");
          deleteModal.classList.remove("show");
          loadItems();
        } catch (err) {
          console.error(err);
          showStatus("Failed to delete item", false);
        } finally {
          confirmDeleteBtn.disabled = false;
          confirmDeleteBtn.textContent = "Delete";
          pendingDeleteId = null;
        }
      });

      // ============================================
      // IMAGE RESIZE
      // ============================================

      async function resizeImage(file, maxWidth = 1500, quality = 0.8) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          const img = new Image();

          reader.onload = (e) => (img.src = e.target.result);
          reader.onerror = reject;

          img.onload = () => {
            const scale = Math.min(1, maxWidth / img.width);
            const width = Math.round(img.width * scale);
            const height = Math.round(img.height * scale);

            const canvas = document.createElement("canvas");
            canvas.width = width;
            canvas.height = height;

            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, width, height);

            canvas.toBlob(
              (blob) => {
                if (!blob) return reject(new Error("Image resize failed"));
                resolve(blob);
              },
              "image/jpeg",
              quality,
            );
          };

          img.onerror = reject;
          reader.readAsDataURL(file);
        });
      }

      // Initialize
      checkSession();
    </script>
  </body>
</html>